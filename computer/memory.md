# 存储器层次结构
## 存储技术
计算机中存储器系统一般有这几种。按照速度降序的顺序是寄存器，高速缓存，内存，磁盘，网络。访问寄存器中的数据一般需要0个时钟周期，访问高速缓存中的数据一般需要1～30个时钟周期，访问内存中的数据一般需要50～200个时钟周期，访问磁盘上的数据一般需要几千万个时钟周期。访问网络的速度当然跟网速的快慢相关了。高速缓存分好几层。

书中有个很好的图片让我们理解双稳态，就是倒转的钟摆，虽然会在状态位上抖动，但是最终总是会处于两个稳定状态中的一个。这就是SRAMS(静态RAM)，速度比DRAM(动态RAM)要快。动态RAM对干扰敏感，但是一般变化周期在10～100毫秒，在这个时间内存储器会发现这个变化，并根据校验位将其恢复成原来的状态。所以DRAM也是稳定的。

一块内存一般是由很多个DRAM芯片组成。这里的设计也比较奇葩，一个16个存储超单元的DRAM芯片只有两根地址引脚。他获取一个超单元的数据一般是传两次信号给芯片，第一次传行位置，芯片将整个行复制到芯片的行缓冲区，第二次传列位置，从行缓冲区将数据取出。行和列的值都是0~4所以只要两根地址引脚就能搞定。如果一个超单元存储8位，那么芯片的数据引脚就是8根。

后面DRAM发展了，可以传一次行位置，然后后面传多个列位置来取同一行的不同列的数据。这样就省去了每次都要把行复制到行缓冲区的过程。

## 访问主存
访问主存一般是通过总线来的。总线有两个事务，读事务(从主存传送数据到CPU)和写事务(从CPU传送数据到主存)。总线是一组并行的导线，数据和地址信息可以使用同一组导线，也可以使用不同的。控制线的信号会同步事务，并标识当前正在被执行的事务的类型。比如：当前关注的这个事务是到主存的吗？就还是到其他IO设备，这个事务是读还是写？总线上的信息是地址还是数据项？

IO桥将系统总线的电子信号翻译成存储器总线的电子信号。IO桥也将系统总线和存储器总线连接到IO总线。像磁盘和图形卡这样的IO设备共享IO总线。

## 磁盘存储
磁盘存储这里主要是理解一下概念：
* 盘片。磁道就是盘面上的同心圆。
* 扇区：每个磁道被划分成一组扇区，每个扇区包含相等数量的数据位，扇区之间由一些间隙分隔开。
* 柱面：柱面是所有盘片表面上到主轴中心的距离相等的磁道的集合。
* 记录区：柱面的集合被分割成不相交的子集合，成为记录区。


磁盘容量的计算感觉不是很难，主要是理解那些概念。
磁盘时间的计算有以下几个概念：寻道时间：将磁头移动到合适的磁道上所话费的时间。旋转时间：将磁盘的扇区旋转到磁头之下所花费的时间。传送时间：读取数据所花费的时间。
由于传送时间相对寻道时间和旋转时间很短暂，所以一般计算的时候被忽略。所以磁盘的访问时间＝ 寻道时间 ＋ 旋转时间。好好理解这几个时间还是很有必要的。

睡了。看《深入理解计算机系统》看得快，不如理解。不然我估计我还要回头看第三遍。不过经典的东西是值得看三遍的。晚安。

在使用存储器映射的IO系统中，地址空间有一块地址是为了与IO设备通信保留的。每个这样的地址成为一个IO端口。虽然不是很理解这里的地址是不是指内存的物理地址还是操作系统中的虚拟地址，不过总得来说只要CPU往这个地址发送消息，那么这个消息会被通知到相应的IO设备。

这里还说了DMA传送的内容，很早之前就在操作系统的书上看到过这个，但是那个时候一直不明白怎么能不通过CPU就读取磁盘中的东西呢，现在看了《深入理解计算机系统》之后总算是有个清晰的印象了，在CPU想读取磁盘中的数据的时候，会发出3个信息，如果缓存中没有这些数据，那么磁盘控制器会发信息将这些数据保存在内存中。

对了，磁盘控制器也维护了逻辑块号和物理扇区的映射关系。跟页表差不多的机制。

# 局部性
局部性还是比较牛逼的，分为时间局部性和空间局部性。还做出了一道练习题(练习题6-9)。

# 存储器层次结构
这一节其实在第一次看的时候就比较熟悉了。为了利用程序的空间局部性，一般相邻两层存储器之间的缓存映射都是有固定块大小的，叫传送单元。

还有缓存的不命中率有很多种，强制性不命中，冲突不命中，容量不命中，这些都很好理解，强制性不命中就是进程启动时缓存中没有任何数据，冲突不命中时内存块强制映射关系导致固定缓存区域满时对应区域的数据无法被缓存，容量不命中就是缓存太小了。
缓存策略里面一个比较牛逼的策略时LRU(Least Recently Used)策略，近期最少使用算法。还有就是牺牲块就是被置换出去的数据块。

# 通用高速缓存存储器结构。
别看存储器层次结构简单，但是通用高速缓存存储器的结构就老复杂了。又分组，又分行，又有偏移。还有标识位和有效位，具体还是看书吧。

睡了睡了。。早睡早起身体才好呀。

《深入理解计算机系统》中高速缓存的目录是这样分的。当每个分组只有一行的时候叫做直接映射高速缓存，如果一个分组有多个行叫做组相联高速缓存，其中有一类比较特殊，只有一个分组，多个行叫做全相联高速缓存(个人觉得全相联高速缓存其实就是直接映射高速缓存，只不过把分组改称了行，只有一个组就没必要叫分组了)。

一般一个高速缓存有多个分组，多个行。一个行保存了多个字节的数据。这里还有一个块的概念，一个行有且仅有一个块，块中只保存数据，而行既包含了数据，也包含了有效位，标识位等信息。如果是多个行，在获取数据的时候，必须遍历当前分组的每个行才能确定是否命中。多个行可以减少冲突不命中(傻逼也知道)。

还有就是地址结构，组索引位是在地址的中间的，前面是标识位，后面是偏移位。索引位在中间是有道理的，这样可以更好地利用程序的空间局部性。

对了，现在的计算机中数据缓存和指令缓存是分开的，分别有自己的缓存。写也是有缓存的，如果写的时候不命中缓存，一般有这两种处理方式：直写，写回。直写表示绕过缓存，直接向下一级写数据。写回是先将内容加载到缓存，然后写缓存，然后让缓存自己向下同步。因为层级越低数据的传送越慢，所以越往下，直写的可能性越小。

存储器层次结构这部分基本就结束了。总得来说感觉收获不是特别大，毕竟看得是第二遍，不过还是有很多东西没有搞清楚，比如缓存的映射到底是怎么样建立的(因为做练习题的时候警察做错)。

不过缓存这个东西貌似十分重要，还是很有必要自己看看的。明天做一下课后作业。。。尽量搞清楚。看书看得快，真的不如看得仔细。加油

晚上要出去办点事情，所以就提早写心得了。加油

PS:对了，还有两个算法还是挺有用的，最不常使用策略(Least-Frequently-Used, LFU)，最近最少使用策略(Least-Recently-Used)。